#!/usr/bin/env bash
[[ "$1" == "source" ]] || \

echo 'Dotfiles - Raviv Cohen'

if [[ "$1" == "-h" || "$1" == "--help" ]]; then cat <<HELP
Usage: $(basename "$0")
See the README for documentation.
https://github.com/ravivcohen/dotfiles
HELP
exit; fi

#Setup the DOTFILES_HOME variable to be the current users home.
#This is needed when running something as STD user.
export DOTFILES_HOME=$HOME
export is_standard_user=false


if [[ ! -d ~/.dotfiles ]]; then
  export lib_file=/tmp/lib_file$$.$RANDOM
  curl -fsSL https://raw.githubusercontent.com/ravivcohen/dotfiles/master/libs/helper_functions.sh -o $lib_file
else
  export lib_file=$HOME/.dotfiles/libs/helper_functions.sh
fi

#All Helper functions can now be found inside libs/helper_functions.
. $lib_file

## TODO: Move this into a get_os functions that is smart return var right away if already set
# OSX
if [[ "$OSTYPE" =~ ^darwin ]]; then
  export OS="osx" 
# Ubuntu.
elif [[ "$(cat /etc/issue 2> /dev/null)" =~ Ubuntu ]]; then
  export OS="ubuntu"
# Arch
elif [[ "$(cat /etc/issue 2> /dev/null)" =~ Arch ]]; then
  export OS="arch"
fi


check_sudo

# Keep-alive: update existing `sudo` time stamp until `.osx` has finished
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &


if [[ "$OS" = "osx" ]]; then
  check_cmd_tools
  if [[ $(xcode-select -p 2>&1) == "/Applications/Xcode.app/Contents/Developer"  ]]; then
    export xcode_installed=true
  fi

  if [[ $(groups | grep -q -e '\badmin\b')$? -ne 0 ]]; then
    echo "Script is running as a standard user."
    export is_standard_user=true
  fi    

fi

#sleep 10

if [[ -e "$HOME/.profile" ]]; then
  e_header "Removing .profile"
  rm -rf "$HOME/.profile"
fi

# If Git is not installed, install it (Ubuntu only, since Git comes standard
# with recent XCode or CLT)
if [[ ! "$(type -P git)" && "$OS" == "ubuntu" ]]; then
  e_header "Installing Git"
  sudo apt-get -qq install git-core
elif [[ ! "$(type -P git)" && "$OS" == "arch" ]]; then
  e_header "Installing Git"
  sudo pacman --noc -S git
fi

# If Git isn't installed by now, something exploded. We gots to quit!
if [[ ! "$(type -P git)" ]]; then
  e_error "Git should be installed. It isn't. Aborting."
  exit 1
fi

DOTFILES="$HOME/.dotfiles"
# Initialize.
if [[ ! -d $DOTFILES ]]; then
  # $DOTFILES directory doesn't exist? Clone it!
  new_dotfiles_install=1
  prompt_delay=15
  e_header "Downloading dotfiles"
  git clone git://github.com/ravivcohen/dotfiles.git ~/.dotfiles
  cd $DOTFILES
elif [[ "$1" != "restart" ]]; then
  # Make sure we have the latest files.
  e_header "Updating dotfiles"
  cd $DOTFILES
  prev_head="$(git rev-parse HEAD)"
  git pull
  git submodule update --init --recursive --quiet
  if [[ "$(git rev-parse HEAD)" != "$prev_head" ]]; then
    e_header "Changes detected, restarting script"
    exec "$0" "restart"
  fi
fi

# Add binaries into the path
PATH=~/.dotfiles/bin:$PATH
export PATH

# Tweak file globbing.
shopt -s dotglob
shopt -s nullglob

# If backups are needed, this is where they'll go.
backup_dir="$HOME/.dotfiles/backups/$(date "+%Y_%m_%d-%H_%M_%S")/"
backup=

e_header "Running Init"
do_stuff "init"


# 2. Copy and Link Over Files 
do_stuff "copy"
do_stuff "link"

# Alert if backups were made.
if [[ "$backup" ]]; then
  echo -e "\nBackups were moved to ~/${backup_dir#$HOME/}"
fi

# Lest I forget to do a few additional things...
if [[ "$new_dotfiles_install" && -e "conf/firsttime_reminder.sh" ]]; then
  e_header "First-Time Reminders"
  source "conf/firsttime_reminder.sh"
fi

# All done!
e_header "All done!"
