#!/bin/bash

echo 'Dotfiles - "Cowboy" Ben Alman - http://benalman.com/'

if [[ "$1" == "-h" || "$1" == "--help" ]]; then cat <<HELP



Usage: $(basename "$0")

See the README for documentation.
https://github.com/cowboy/dotfiles

Copyright (c) 2012 "Cowboy" Ben Alman
Licensed under the MIT license.
http://benalman.com/about/license/
HELP
exit; fi

#Setup the DOTFILES_HOME variable to be the current users home.
#This is needed when running something as STD user.
export DOTFILES_HOME=$HOME

#
if [[ ! -d ~/.dotfiles ]]; then
  export lib_file=/tmp/lib_file$$.$RANDOM
  curl -fsSL https://raw.githubusercontent.com/ravivcohen/dotfiles/master/libs/helper_functions.sh -o $lib_file
else
  export lib_file=$HOME/.dotfiles/libs/helper_functions
fi

#All Helper functions can now be found inside libs/helper_functions.
. $lib_file

# On OSX we wanna support standard users as well:
# 1. Install init as root.
# 2. Switch to regular user for copying/linking/ etc..
while true; do
    echo "The config part of this script will require dosu user"
    read -p "Do you need to login as an administrator (y/n) ?: " yn
    case $yn in
        [Yy]* ) 
              is_standard_user=true
              read -p "Enter the Administrator Username to use: " username
              echo "Please enter password for $username"
              check_std_user_sudo_access
              #since we have the enitre file and it might contain the orginal
              #dosu warining menu we look for root anywhere in the file.
              if [[ $test_root_access != *root* ]]; then
                echo "Sorry, you need root to run parts of this script exiting."
                exit 1
              fi
              break
              ;;
        [Nn]* ) 
              is_standard_user=false
              echo "Testing dosu Acess:"
              if [[ $(dosu whoami) != "root" ]]; then
                echo "Sorry, you need root to run parts of this script exiting."
                exit 1
              fi
              break
              ;;
        * ) echo "Do you wish to login as an administrator (y/n) ?:";;
    esac
done

# Keep-alive: update existing `dosu` time stamp until `.osx` has finished
if [ "$is_standard_user" = false ]; then
  while true; do dosu -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &
fi

# Ensure that we can actually, like, compile anything.
if [[ ! "$(type -P gcc)" && "$OSTYPE" =~ ^darwin ]]; then
  e_error "The XCode Command Line Tools must be installed first."
  exit 1
fi

# If Git is not installed...
if [[ ! "$(type -P git)" ]]; then
  # OSX
  if [[ "$OSTYPE" =~ ^darwin ]]; then
    # It's easiest to get Git via Homebrew, so get that first.
    if [[ ! "$(type -P brew)" ]]; then
      e_header "Installing Homebrew"
      true | /usr/bin/ruby -e "$(/usr/bin/curl -fsSL https://raw.github.com/mxcl/homebrew/master/Library/Contributions/install_homebrew.rb)"
    fi
    # If Homebrew was installed, install Git.
    if [[ "$(type -P brew)" ]]; then
      e_header "Updating Homebrew"
      brew update
      e_header "Installing Git"
      brew install git
    fi
  # Ubuntu.
  elif [[ "$(cat /etc/issue 2> /dev/null)" =~ Ubuntu ]]; then
    # Git is fairly easy.
    e_header "Installing Git"
    dosu apt-get -qq install git-core
  fi
fi

# If Git isn't installed by now, something exploded. We gots to quit!
if [[ ! "$(type -P git)" ]]; then
  e_error "Git should be installed. It isn't. Aborting."
  exit 1
fi

## Check if .dotfiles exist
if [[ ! -d ~/.dotfiles ]]; then
  new_dotfiles_install=1
  # ~/.dotfiles doesn't exist? Clone it!
  e_header "Downloading dotfiles"
  git clone --recursive git://github.com/ravivcohen/dotfiles.git ~/.dotfiles
  cd ~/.dotfiles
else
    cd ~/.dotfiles
    # Check if dotfiles dirty
    git update-index -q --refresh
    git diff-index --quiet HEAD
    if [[ $? -eq 0 ]] && [[ -z "$(git ls-files --exclude-standard --others)" ]]; then
      
      # Check if the dotfiles dir is out-of-date
      LOCAL=$(git rev-parse @)
      REMOTE=$(git rev-parse @{u})
    
      if [ $LOCAL = $REMOTE ]; then
          e_header "Dotfiles are up-to-date"
          exit 0
      elif [ $LOCAL = $(git merge-base @ @{u}) ]; then
          e_header "Updating dotfiles"
          git pull
          # #Dont have any submodules installed for now
          #git submodule update --init --recursive --quiet
      else
          e_error "Dotfiles out-of-sync"
          git status
          exit 1
      fi

    else
      e_error "Dotfiles are dirty"
      git status
      exit 1
   fi
fi

# Add binaries into the path
PATH=~/.dotfiles/bin:$PATH
export PATH

# Tweak file globbing.
shopt -s dotglob
shopt -s nullglob


# Create caches directory, if it doesn't already exist.
mkdir -p "$HOME/.dotfiles/caches"

# If backups are needed, this is where they'll go.
backup_dir="$HOME/.dotfiles/backups/$(date "+%Y_%m_%d-%H_%M_%S")/"
backup=

# do_stuff Executes code for each file in these subdirectories.

# 1. First We Init the system
do_stuff "init"

exit

# 2. Second We Setup OH-MY-ZSH  
if [[ "$new_dotfiles_install" ]]; then
  e_header "Setup oh-my-zsh"
  ##SETUP OH MY ZSH ONLY ON THE FIRST TIME
  wget --no-check-certificate https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh -O - | sh
fi

# 3. Copy and Link Over Files 
do_stuff "copy"
do_stuff "link"

# Alert if backups were made.
if [[ "$backup" ]]; then
  echo -e "\nBackups were moved to ~/${backup_dir#$HOME/}"
fi


# Lest I forget to do a few additional things...
if [[ "$new_dotfiles_install" && -e "conf/firsttime_reminder.sh" ]]; then
  e_header "First-Time Reminders"
  source "conf/firsttime_reminder.sh"
fi

# All done!
e_header "All done!"

#Delete the libs file.
rm $lib_file