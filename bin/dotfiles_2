#!/bin/bash

export lib_file=$HOME/.dotfiles/libs/helper_functions.sh 

#All Helper functions can now be found inside libs/helper_functions.
. $lib_file

## Check if .dotfiles exist
if [[ ! -d ~/.dotfiles ]]; then
  new_dotfiles_install=1
  # ~/.dotfiles doesn't exist? Clone it!
  e_header "Downloading dotfiles"
  git clone --recursive git://github.com/ravivcohen/dotfiles.git ~/.dotfiles
  cd ~/.dotfiles
else
	cd ~/.dotfiles
	# Update the Index
    git update-index -q --refresh
    git diff-index --quiet HEAD
    if [[ $? -eq 0 ]] && [[ -z "$(git ls-files --exclude-standard --others)" ]]; then
    	# Check if the dotfiles dir is out-of-date
    	echo clean
    	# Clean Repo. Lets check origin-master.
    	LOCAL=$(git rev-parse @)
		REMOTE=$(git rev-parse @{u})
		BASE=$(git merge-base @ @{u})
		if [ $LOCAL = $REMOTE ]; then
    		e_header "Dotfiles are up-to-date"
		elif [ $LOCAL = $BASE ]; then
    		e_header "Updating dotfiles"
			git pull
			# #Dont have any submodules installed for now
			#git submodule update --init --recursive --quiet
		else
    		e_error "Dotfiles out-of-sync"
    		git status
    		exit 1
		fi

   	else
   		e_error "Dotfiles out-of-sync"
    	git status
    	exit 1
   fi
   #if [[ test -z "$u" ]]; then
  #	echo $u
  #fi
  # Make sure we have the latest files.
  # e_header "Updating dotfiles"
  # cd ~/.dotfiles
  # git pull
  # #Dont have any submodules installed for now
  #git submodule update --init --recursive --quiet
fi

#[[ $(git diff --shortstat 2> /dev/null | tail -n1) != "" ]]